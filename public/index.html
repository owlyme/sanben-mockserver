<html>
    <head>
        <title>san ben</title>
        <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.0/axios.min.js"></script>
        <link rel="stylesheet" type="text/css" href="http://unpkg.com/iview/dist/styles/iview.css">
        <script type="text/javascript" src="http://vuejs.org/js/vue.min.js"></script>
        <script type="text/javascript" src="http://unpkg.com/iview/dist/iview.min.js"></script>
        <style>
            .flex {
            display: flex;
            }
            .ivu-input-wrapper,
            .ivu-select,
            .ivu-btn {
                margin-left: 8px;
            }

        </style>
    </head>
    <body>
        <div id="app">
            <div>
                <div>
                <Row>
                    <i-col span="3">
                        接口名：
                    </i-col>
                    <i-col span="16">
                        <i-input  v-model="api"  />
                    </i-col>
                    <i-col span="5">
                        <i-button type="primary"  v-on:click="createData">提交</i-button>
                        <!-- <i-button v-on:click="modifyData">修改</i-button> -->
                        <i-button type="primary"  v-on:click="viewData">查看数据</i-button>
    
                        <i-button type="primary"  v-show="data_type==='LIST'" v-on:click="addListItem(mockData)">添加项目</i-button>
                    </i-col>
                </Row>
            </div>
                <Row>
                    <i-col span="3">
                        接口method：
                    </i-col>
                    <i-col span="16">
                        <input v-model="method" type="radio" value="GET" name="method" /> GET
                        <input v-model="method" type="radio" value="POST" name="method" /> POST
                    </i-col>
                </Row>
                <Row>
                    <i-col span="3">
                        数据类型:
                    </i-col>
                    <i-col span="16">
                        <input v-model="data_type" type="radio" value="JSON" name="data_type" /> JSON
                        <input v-model="data_type" type="radio" value="LIST" name="data_type" /> LIST
                    </i-col>
                </Row>

                <Row>
                    <i-col span="3">
                        接口数据：
                    </i-col>
                    <i-col span="16">
                        <template v-for="(arry_item, index) in (mockData || [])" >
                            <div v-show="data_type === 'LIST'">
                                LIST[{{index}}] 
                                <i-button
                                    v-show="mockData.length !== 1"
                                     v-on:click="removeListItem(mockData, index)">删除项目</i-button>
                            </div>
                            <data-list 
                            :key="index"
                            :data="arry_item" />
                        </template>
                    </i-col>
                </Row>

                <Row>
                    <i-col span="3">
                       数据预览：
                    </i-col>
                    <i-col span="16">
                        <pre>{{viewMockData}}</pre>
                    </i-col>
                </Row>
            </div>
        </div>

        <script>
            const temp = {
                key: null, 
                value: null,
                data_type_value: 'string'
            }
            
            function debounce(fn) {
                let time = null
                return function() {
                    clearTimeout(time)
                    setTimeout(fn, 300)
                }   
            }
            
            function createJson(array) {
                return array.reduce((acc, data) => 
                    {   
                        let value = null;
                        if ( data.data_type_value === "object") {
                            value = createJson(data.value)
                        } else if (data.data_type_value === "array") {
                            value = data.value.map(arr_item => createJson(arr_item))
                        } else {
                            value = data.value
                        }

                        return {
                            ...acc, 
                            [data.key]: value,
                            // data_type_value: data.data_type_value
                        }
                    }, {})
            }

            Vue.component('data-list', {
                template: `
                    <ul>
                        <li v-for="(item, index) in (data || [])"   v-bind:key="index">
                            <div class="flex">
                                <div class="flex"><i-input v-model="item.key" /><div>:</div></div>

                                <div class="flex" v-if="item.data_type_value !== 'array' && item.data_type_value !== 'object'">
                                    <i-input  v-model="item.value" />
                                </div>

                                <div class="flex">
                                    <i-select
                                    style="width: 80px"
                                    :value="item.data_type_value" 
                                    v-on:on-change="(val) => onTypeChange(val, item, index)">
                                        <i-option value="string">String</i-option>
                                        <i-option value="boolean">Boolean</i-option>
                                        <i-option value="number">Number</i-option>
                                        <i-option value="array">Array</i-option>
                                        <i-option value="object">Object</i-option>
                                    </i-select>
                                    <i-button
                                    v-if="data.length > 1"
                                     v-on:click="removeProperty(data, index)">删除字段</i-button>
                                    <i-button
                                     type="primary" 
                                     v-show="index + 1 === data.length"
                                     v-on:click="addProperty(data)">添加字段</i-button>

                                     <i-button 
                                     type="primary"
                                     v-show="item.data_type_value === 'array'"
                                     v-on:click="addListItem(item.value)">添加项目</i-button>
                                </div>
                            </div>
                           
                            <div v-if="item.data_type_value === 'object'"
                                style="paddingLeft:30px">
                                <data-list :data="item.value" />
                            </div>

                            <div v-if="item.data_type_value === 'array'"
                                style="paddingLeft:30px">

                                <template v-for="(arry_item, index) in (item.value || [])"  >
                                    <div>
                                        sub list[{{index}}]
                                        <i-button
                                        v-on:click="removeListItem(item.value, index)">删除项目</i-button>
                                    </div>
                                    <data-list 
                                    :key="index"
                                    :data="arry_item" />
                                 </template>
                            </div>
                        </li>
                       
                    </ul>
                `,
                
                props: ['data', 'title'],
                data() {
                    return {}
                },
                created() {
                    console.log(this.data)
                },
                methods: {
                    addProperty(item) {
                        item.push({...temp})
                    },
                    removeProperty(data, index) {
                        data.splice(index, 1)
                    },
                    onTypeChange(e, item, index) {
                        console.log(e)
                        let type = e
                        item.data_type_value = type

                        if (type === 'object') {
                            item.value = [
                                {...temp}
                            ]
                        } else if (type === 'array') {
                            item.value = [
                                [{...temp}]
                            ]
                        }
                    },
                    addListItem(item) {
                        item.push([{...temp}])
                    },
                    removeListItem(data, index) {
                        data.splice(index, 1)
                    }
                }
            })

            var app = new Vue({
                el: '#app',
                data: {
                    api: 'test',
                    method: 'GET',
                    data_type: localStorage.data_type || 'JSON',
                    mockData: localStorage.mockData ? JSON.parse(localStorage.mockData) : [[{...temp}]],
                   
                },
                computed: {
                    viewMockData() {
                        let data = null
                        if (this.data_type === "JSON") {
                            data = createJson(this.mockData[0])
                        } else {
                            data = this.mockData.map(createJson)
                        }
                        return data
                    }
                },
                watch: {
                    data_type(nv) {
                        localStorage.data_type = nv
                    },
                    mockData(nv) {
                        console.log('mockData', nv)
                        localStorage.mockData = JSON.stringify(nv)
                    }
                },

           
                methods: {
                    createData() {
                        axios.post('/api/create', {
                            api: this.api,
                            method: this.method,
                            mockData: {
                                type: this.data_type,
                                data: this.mockData
                            }
                            // mockData: this.mockData
                        }).then(res => {
                            console.log(res)
                        })
                    },
                    modifyData() {
                        axios.post('/api/create', {
                            api: this.api,
                            mockData: this.mockData
                        }).then(res => {
                            console.log(res)
                        })
                    },
                    viewData() {
                        let url = this.api
                        let method = this.method.toLowerCase()
                        let param = method === 'get' ? {
                                param: {
                                    api: this.api,
                                    mockData: this.mockData
                                }
                            } :  {
                                api: this.api,
                                mockData: this.mockData
                            };
                            
                        axios[method]('/api-mock/' + this.api, {
                            ...param
                        }).then(res => {
                            console.log(res)
                        })
                    },
                    addListItem() {
                        this.mockData.push([{...temp}])
                    },
                    removeListItem(data, index) {
                        data.splice(index, 1)
                    }
                }
            })
        </script>
    </body>
</html>